from bottle import get, request, response

import os
import fnmatch
import json
import sys

sys.path.insert(0,'../..')

from fjp.dmccooey_parser import load_from_file
from fjp.polyhedron import Polyhedron

dmcooeyModels = []

i = 0

for root, dirnames, filenames in os.walk('../../data/dmccooey/polyhedra'):
  for filename in fnmatch.filter(filenames, '**.txt'):
    path = os.path.join(root, filename)
    name = filename[:-4]
    
    dmcooeyModels.append({
          "id": i,
          "name": name,
          "type": "dmcooey",
          "path": path
        })
    i += 1

@get('/models')
def listing_handler():
    '''Handles name listing'''

    response.headers['Content-Type'] = 'application/json'
    response.headers['Cache-Control'] = 'no-cache'
    return json.dumps({
      'models': dmcooeyModels
    })

@get('/models/<model_id:int>')
def individual_handler(model_id):
    '''Handles name listing'''

    response.headers['Content-Type'] = 'application/json'
    response.headers['Cache-Control'] = 'no-cache'

    model = "not found"

    if True: # (m["id"] == "vase"):
      data = {'vertices': [(-0.3882212544999999, 0.22575205180000002, 0.10882729580000006), (-0.49441745857999986, 0.3996130939000002, 0.09102012770000001), (-0.49441745857999986, 0.3996130939000002, -0.09102012769999979), (-0.3882212544999999, 0.22575205180000002, -0.10882729579999983), (-0.31141054175999994, 0.10000000000000009, -0.06544614629999979), (-0.31141054175999994, 0.10000000000000009, 0.06544614630000001), (0.34071611720000017, 1.2, 0.12434754600000009), (0.4515207295000001, 1.1573828414000003, 0.049904329900000155), (0.4515207295000001, 1.1573828414000003, -0.04990432989999993), (0.34071611720000017, 1.2, -0.12434754599999986), (0.11521419820000012, 1.2, 0.34391201390000004), (0.24250179400000005, 1.1573828414000003, 0.3841279621000002), (0.32053534640000003, 1.1573828414000003, 0.32189828060000014), (0.3096518507000001, 1.2, 0.1888531602000001), (-0.1970463619999998, 1.2, 0.3045037207000001), (-0.1491259385999999, 1.1573828414000003, 0.42909540410000013), (-0.05181969029999989, 1.1573828414000003, 0.4513049202000001), (0.04541342480000021, 1.2, 0.3598435849000001), (-0.36092699262999994, 1.2, 0.035797915200000086), (-0.42845879775999984, 1.1573828414000003, 0.1509452548000001), (-0.3851534432699999, 1.1573828414000003, 0.2408697500000001), (-0.25302223619999986, 1.2, 0.2598644507000001), (-0.25302223619999986, 1.2, -0.25986445067999986), (-0.3851534432699999, 1.1573828414000003, -0.24086974999999988), (-0.42845879775999984, 1.1573828414000003, -0.15094525479999987), (-0.36092699262999994, 1.2, -0.035797915199999863), (0.04541342480000021, 1.2, -0.3598435848899999), (-0.05181969029999989, 1.1573828414000003, -0.4513049202399999), (-0.1491259385999999, 1.1573828414000003, -0.4290954040499999), (-0.1970463619999998, 1.2, -0.3045037207399999), (0.3096518507000001, 1.2, -0.18885316019999987), (0.32053534640000003, 1.1573828414000003, -0.3218982805899999), (0.24250179400000005, 1.1573828414000003, -0.3841279620699999), (0.11521419820000012, 1.2, -0.3439120138599999), (0.4441978737000001, 1.0924810159, 0.3021426290000002), (0.5131774638000002, 1.0924810159, 0.15890503420000002), (0.04072822470000004, 1.0924810159, 0.5356707300000001), (0.1957239567000002, 1.0924810159, 0.5002939656000001), (-0.39341060816999984, 1.0924810159, 0.36582784560000015), (-0.26911368178999984, 1.0924810159, 0.4649513367000002), (-0.5313032289999999, 1.0924810159, -0.07949086799999994), (-0.5313032289999999, 1.0924810159, 0.07949086800000016), (-0.26911368178999984, 1.0924810159, -0.4649513367299999), (-0.39341060816999984, 1.0924810159, -0.3658278456199999), (0.1957239567000002, 1.0924810159, -0.50029396559), (0.04072822470000004, 1.0924810159, -0.5356707299799999), (0.4441978737000001, 1.0924810159, -0.3021426289799999), (0.5131774638000002, 1.0924810159, -0.1589050341999998), (0.5858032385, 1.0160328320000003, 0.09897563120000008), (0.5858032385, 1.0160328320000003, -0.09897563119999986), (0.2878600806, 1.0160328320000003, 0.5197097111000002), (0.44262460960000016, 1.0160328320000003, 0.3962891177000001), (-0.22684758919999992, 1.0160328320000003, 0.5490917783), (-0.033859378199999846, 1.0160328320000003, 0.5931400781), (-0.5707343975199999, 1.0160328320000003, 0.16499653710000017), (-0.4848465636199999, 1.0160328320000003, 0.3433444619000001), (-0.4848465636199999, 1.0160328320000003, -0.3433444618899999), (-0.5707343975199999, 1.0160328320000003, -0.16499653709999995), (-0.033859378199999846, 1.0160328320000003, -0.5931400781199999), (-0.22684758919999992, 1.0160328320000003, -0.5490917783299999), (0.44262460960000016, 1.0160328320000003, -0.39628911766999986), (0.2878600806, 1.0160328320000003, -0.5197097110499999), (0.5080701871000002, 0.9263101329000001, 0.36704993910000017), (0.6037477783, 0.9263101329000001, 0.16837337380000017), (0.029805382300000183, 0.9263101329000001, 0.6260771614), (0.24479097820000018, 0.9263101329000001, 0.5770081020000002), (-0.47090348330999987, 0.9263101329000001, 0.4136555115), (-0.2984984212899999, 0.9263101329000001, 0.5511439606000001), (-0.6170124212999999, 0.9263101329000001, 0.11025717550000014), (-0.6170124212999999, 0.9263101329000001, -0.11025717549999992), (-0.2984984212899999, 0.9263101329000001, -0.5511439605799999), (-0.47090348330999987, 0.9263101329000001, -0.4136555115099999), (0.24479097820000018, 0.9263101329000001, -0.5770081020099999), (0.029805382300000183, 0.9263101329000001, -0.6260771613699999), (0.5080701871000002, 0.9263101329000001, -0.36704993906999994), (0.6037477783, 0.9263101329000001, -0.16837337379999995), (0.6248701318000001, 0.8206983652, 0.11477594300000016), (0.6248701318000001, 0.8206983652, -0.11477594299999994), (0.2998647090000002, 0.8206983652, 0.5601047715), (0.4793356004, 0.8206983652, 0.4169815115000002), (-0.2509449558599999, 0.8206983652, 0.5836632830000001), (-0.027148414799999854, 0.8206983652, 0.6347433831), (-0.6127879505899999, 0.8206983652, 0.1677114378000002), (-0.5131891199299999, 0.8206983652, 0.37453054070000014), (-0.5131891199299999, 0.8206983652, -0.3745305407299999), (-0.6127879505899999, 0.8206983652, -0.16771143779999997), (-0.027148414799999854, 0.8206983652, -0.6347433830599999), (-0.2509449558599999, 0.8206983652, -0.5836632829699999), (0.4793356004, 0.8206983652, -0.41698151152999985), (0.2998647090000002, 0.8206983652, -0.5601047715099999), (0.4985908871000002, 0.6976566087, 0.36565420400000015), (0.5967463018000001, 0.6976566087, 0.1618323852000001), (0.024986365000000177, 0.6976566087, 0.6177957196000001), (0.24553957980000019, 0.6976566087, 0.5674558876000002), (-0.46743339954999985, 0.6976566087, 0.4047244576000002), (-0.29056345381999993, 0.6976566087, 0.5457735326000002), (-0.6078662803299999, 0.6976566087, -0.11311257589999979), (-0.6078662803299999, 0.6976566087, 0.11311257590000001), (-0.29056345381999993, 0.6976566087, -0.5457735325999999), (-0.46743339954999985, 0.6976566087, -0.40472445758999986), (0.24553957980000019, 0.6976566087, -0.5674558875499999), (0.024986365000000177, 0.6976566087, -0.6177957195899999), (0.5967463018000001, 0.6976566087, -0.16183238519999987), (0.4985908871000002, 0.6976566087, -0.36565420400999993), (0.5646210049, 0.5571084349000002, 0.10523867650000018), (0.5646210049, 0.5571084349000002, -0.10523867649999996), (0.26975652800000005, 0.5571084349000002, 0.5070537188000002), (0.4343143489000001, 0.5571084349000002, 0.3758232357000002), (-0.22824011649999987, 0.5571084349000002, 0.5270469689000001), (-0.023039870199999868, 0.5571084349000002, 0.5738825861000001), (-0.5543672980399998, 0.5571084349000002, 0.15016310160000002), (-0.4630445971299999, 0.5571084349000002, 0.3397966440000002), (-0.4630445971299999, 0.5571084349000002, -0.33979664399999987), (-0.5543672980399998, 0.5571084349000002, -0.1501631015999998), (-0.023039870199999868, 0.5571084349000002, -0.5738825860699999), (-0.22824011649999987, 0.5571084349000002, -0.5270469689099999), (0.4343143489000001, 0.5571084349000002, -0.3758232357499999), (0.26975652800000005, 0.5571084349000002, -0.5070537188499998), (0.4059625846000001, 0.3996130939000002, 0.29652599700000004), (0.4849468912000001, 0.3996130939000002, 0.13251339420000008), (0.021280171600000175, 0.3996130939000002, 0.5022752645000002), (0.19875629770000014, 0.3996130939000002, 0.46176749680000007), (-0.37942664461999986, 0.3996130939000002, 0.3298010132000002), (-0.23710184193999984, 0.3996130939000002, 0.44330125600000003), (-0.23710184193999984, 0.3996130939000002, -0.4433012559499999), (-0.37942664461999986, 0.3996130939000002, -0.3298010132399999), (0.19875629770000014, 0.3996130939000002, -0.46176749681999985), (0.021280171600000175, 0.3996130939000002, -0.5022752644499999), (0.4849468912000001, 0.3996130939000002, -0.13251339419999986), (0.4059625846000001, 0.3996130939000002, -0.29652599697999993), (0.3969936582000002, 0.22575205180000002, 0.0703928840000001), (0.3969936582000002, 0.22575205180000002, -0.07039288399999988), (0.19248612450000002, 0.22575205180000002, 0.35427138560000015), (0.3025568701000001, 0.22575205180000002, 0.26649289500000006), (-0.1569673869999999, 0.22575205180000002, 0.3713763080000001), (-0.019711412199999945, 0.22575205180000002, 0.4027040886000002), (-0.3271365990799999, 0.22575205180000002, 0.23567088980000017), (-0.3271365990799999, 0.22575205180000002, -0.23567088980999984), (-0.019711412199999945, 0.22575205180000002, -0.40270408861999984), (-0.1569673869999999, 0.22575205180000002, -0.3713763080499999), (0.3025568701000001, 0.22575205180000002, -0.26649289502999984), (0.19248612450000002, 0.22575205180000002, -0.35427138559999993), (0.2521751846000002, 0.10000000000000009, 0.1940809106000001), (0.30896722190000014, 0.10000000000000009, 0.07615102990000011), (0.13310063930000005, 0.10000000000000009, 0.2890396917000002), (0.0054900898000000975, 0.10000000000000009, 0.3181659669000001), (-0.14299343939999987, 0.10000000000000009, 0.28427557030000017), (-0.24532915453999993, 0.10000000000000009, 0.20266556070000008), (-0.24532915453999993, 0.10000000000000009, -0.20266556069999986), (-0.14299343939999987, 0.10000000000000009, -0.28427557029999984), (0.0054900898000000975, 0.10000000000000009, -0.3181659669099999), (0.13310063930000005, 0.10000000000000009, -0.2890396917199999), (0.2521751846000002, 0.10000000000000009, -0.19408091059999988), (0.30896722190000014, 0.10000000000000009, -0.07615102989999989)], 'faces': [[5, 4, 3, 2, 1, 0], [9, 8, 7, 6], [13, 12, 11, 10], [17, 16, 15, 14], [21, 20, 19, 18], [25, 24, 23, 22], [29, 28, 27, 26], [33, 32, 31, 30], [13, 6, 7, 35, 34, 12], [17, 10, 11, 37, 36, 16], [21, 14, 15, 39, 38, 20], [25, 18, 19, 41, 40, 24], [29, 22, 23, 43, 42, 28], [33, 26, 27, 45, 44, 32], [47, 8, 9, 30, 31, 46], [8, 47, 49, 48, 35, 7], [34, 51, 50, 37, 11, 12], [36, 53, 52, 39, 15, 16], [38, 55, 54, 41, 19, 20], [40, 57, 56, 43, 23, 24], [42, 59, 58, 45, 27, 28], [44, 61, 60, 46, 31, 32], [48, 63, 62, 51, 34, 35], [50, 65, 64, 53, 36, 37], [52, 67, 66, 55, 38, 39], [69, 57, 40, 41, 54, 68], [56, 71, 70, 59, 42, 43], [58, 73, 72, 61, 44, 45], [75, 49, 47, 46, 60, 74], [49, 75, 77, 76, 63, 48], [62, 79, 78, 65, 50, 51], [64, 81, 80, 67, 52, 53], [66, 83, 82, 68, 54, 55], [69, 85, 84, 71, 56, 57], [70, 87, 86, 73, 58, 59], [72, 89, 88, 74, 60, 61], [76, 91, 90, 79, 62, 63], [78, 93, 92, 81, 64, 65], [80, 95, 94, 83, 66, 67], [82, 97, 96, 85, 69, 68], [84, 99, 98, 87, 70, 71], [86, 101, 100, 89, 72, 73], [88, 103, 102, 77, 75, 74], [102, 105, 104, 91, 76, 77], [90, 107, 106, 93, 78, 79], [92, 109, 108, 95, 80, 81], [94, 111, 110, 97, 82, 83], [96, 113, 112, 99, 84, 85], [98, 115, 114, 101, 86, 87], [100, 117, 116, 103, 88, 89], [104, 119, 118, 107, 90, 91], [106, 121, 120, 109, 92, 93], [108, 123, 122, 111, 94, 95], [110, 1, 2, 113, 96, 97], [112, 125, 124, 115, 98, 99], [114, 127, 126, 117, 100, 101], [116, 129, 128, 105, 102, 103], [128, 131, 130, 119, 104, 105], [118, 133, 132, 121, 106, 107], [120, 135, 134, 123, 108, 109], [122, 136, 0, 1, 110, 111], [2, 3, 137, 125, 112, 113], [124, 139, 138, 127, 114, 115], [126, 141, 140, 129, 116, 117], [130, 143, 142, 133, 118, 119], [142, 144, 132, 133], [144, 145, 135, 120, 121, 132], [145, 146, 134, 135], [146, 147, 136, 122, 123, 134], [147, 5, 0, 136], [4, 148, 137, 3], [148, 149, 139, 124, 125, 137], [149, 150, 138, 139], [150, 151, 141, 126, 127, 138], [151, 152, 140, 141], [152, 153, 131, 128, 129, 140], [153, 143, 130, 131], [143, 153, 152, 151, 150, 149, 148, 4, 5, 147, 146, 145, 144, 142], [10, 17, 14, 21, 18, 25, 22, 29, 26, 33, 30, 9, 6, 13]]}



      # {"vertices": [[0.3, 0.0, 0.0], [0.38221925346489866, 0.27040816326530603, -0.2776985426647092], [0.09270509831248423, 0.0, -0.2853169548885461], [-0.14599476366898015, 0.2704081632653061, -0.4493256806578124], [-0.24270509831248419, 0.0, -0.17633557568774194], [-0.4724489795918368, 0.2704081632653061, -5.785831306175761e-17], [-0.24270509831248427, 0.0, 0.1763355756877419], [-0.14599476366898034, 0.27040816326530603, 0.4493256806578123], [0.09270509831248415, 0.0, 0.2853169548885461], [0.3822192534648986, 0.2704081632653061, 0.27769854266470934], [0.1822569619884894, 0.5102040816326531, -0.5609292514475498], [-0.4771549211721628, 0.510204081632653, -0.3466733426786219], [-0.4771549211721629, 0.5102040816326531, 0.3466733426786218], [0.18225696198848923, 0.5102040816326531, 0.5609292514475498], [0.5897959183673469, 0.5102040816326531, 0.0], [0.5275121014342768, 0.7193877551020406, -0.38325997572947984], [-0.20149169327101146, 0.7193877551020407, -0.6201276672577583], [-0.6520408163265305, 0.7193877551020407, -7.98519698627713e-17], [-0.2014916932710117, 0.7193877551020406, 0.6201276672577581], [0.5275121014342767, 0.7193877551020407, 0.38325997572947995], [0.20369895751654696, 0.8979591836734693, -0.6269209280884379], [-0.5332907942512407, 0.8979591836734692, -0.3874584418172833], [-0.5332907942512408, 0.8979591836734693, 0.3874584418172832], [0.2036989575165468, 0.8979591836734693, 0.6269209280884379], [0.6591836734693877, 0.8979591836734693, 0.0], [0.49449099962305465, 1.0459183673469385, -0.35926874094203204], [-0.1888787547250953, 1.0459183673469388, -0.5813090339395889], [-0.6112244897959185, 1.0459183673469388, -7.485341149890456e-17], [-0.18887875472509552, 1.0459183673469385, 0.5813090339395888], [0.4944909996230546, 1.0459183673469388, 0.3592687409420322], [0.157031084896657, 1.163265306122449, -0.48329198481121083], [-0.41111271754971823, 1.1632653061224487, -0.2986908731037262], [-0.41111271754971834, 1.163265306122449, 0.29869087310372616], [0.15703108489665685, 1.163265306122449, 0.48329198481121083], [0.5081632653061225, 1.163265306122449, 0.0], [0.28315594803123156, 1.2499999999999998, -0.20572483830236554], [-0.1081559480312315, 1.25, -0.33286978070330375], [-0.35, 1.25, -4.286263797015736e-17], [-0.10815594803123164, 1.2499999999999998, 0.3328697807033037], [0.2831559480312315, 1.25, 0.20572483830236563]], "faces": [[2, 1, 0], [4, 3, 2], [6, 5, 4], [8, 7, 6], [0, 9, 8], [10, 1, 2], [2, 3, 10], [11, 3, 4], [4, 5, 11], [12, 5, 6], [6, 7, 12], [13, 7, 8], [8, 9, 13], [14, 9, 0], [0, 1, 14], [15, 14, 1], [1, 10, 15], [16, 10, 3], [3, 11, 16], [17, 11, 5], [5, 12, 17], [18, 12, 7], [7, 13, 18], [19, 13, 9], [9, 14, 19], [20, 15, 10], [10, 16, 20], [21, 16, 11], [11, 17, 21], [22, 17, 12], [12, 18, 22], [23, 18, 13], [13, 19, 23], [24, 19, 14], [14, 15, 24], [25, 24, 15], [15, 20, 25], [26, 20, 16], [16, 21, 26], [27, 21, 17], [17, 22, 27], [28, 22, 18], [18, 23, 28], [29, 23, 19], [19, 24, 29], [30, 25, 20], [20, 26, 30], [31, 26, 21], [21, 27, 31], [32, 27, 22], [22, 28, 32], [33, 28, 23], [23, 29, 33], [34, 29, 24], [24, 25, 34], [35, 34, 25], [25, 30, 35], [36, 30, 26], [26, 31, 36], [37, 31, 27], [27, 32, 37], [38, 32, 28], [28, 33, 38], [39, 33, 29], [29, 34, 39], [30, 36, 35], [31, 37, 36], [32, 38, 37], [33, 39, 38], [34, 35, 39], [8, 6, 4, 2, 0], [35, 36, 37, 38, 39]]}
      poly = Polyhedron(data["vertices"], data["faces"])
      model = {}
      model["data"] = {
        "vertices": [list(v) for v in poly.vertices],
        "faces": [list(f) for f in poly.faces],
        "triangles": [list(v) for v in poly.save_3d_fjp(120)]
      }
    else:
      for m in dmcooeyModels:
        if m["id"] == model_id:
          model = m
          data = load_from_file(m["path"])
          poly = Polyhedron(data["vertices"], data["faces"])
          model["data"] = {
            "vertices": [list(v) for v in poly.vertices],
            "faces": [list(f) for f in poly.faces],
            "triangles": [list(v) for v in poly.save_3d_fjp()]
          }

          break
      
    return json.dumps({
      "model": model
    })
